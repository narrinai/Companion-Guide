<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtable Integration Test - Companion Guide</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="style.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-header {
            color: #333;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-controls {
            margin: 20px 0;
        }
        .test-controls button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        .test-controls button:hover {
            background: #0056b3;
        }
        .api-response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .companions-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <h1><a href="/"><img src="/images/logo.svg" alt="Companion Guide" width="32" height="32">Companion Guide - Test</a></h1>
        </nav>
    </header>

    <main class="test-container">
        <h1>üß™ Airtable Integration Test</h1>
        <p>Deze pagina test de Airtable integratie voordat we het live zetten.</p>

        <!-- API Connection Test -->
        <section class="test-section">
            <h2 class="test-header">üì° API Connection Test</h2>
            <div class="test-controls">
                <button onclick="testApiConnection()">Test API Connection</button>
                <button onclick="testWithFilters()">Test met Filters</button>
                <button onclick="testSorting()">Test Sorting</button>
                <button onclick="clearResults()">Clear Results</button>
            </div>
            <div id="api-status" class="status loading">Klaar voor test...</div>
            <div id="api-response" class="api-response"></div>
        </section>

        <!-- Companion Rendering Test -->
        <section class="test-section">
            <h2 class="test-header">üé® Companion Card Rendering Test</h2>
            <div class="test-controls">
                <button onclick="testCompanionCards()">Test Companion Cards</button>
                <button onclick="testFeaturedOnly()">Test Featured Only</button>
                <button onclick="testByCategory()">Test by Category</button>
            </div>
            <div id="render-status" class="status loading">Klaar voor test...</div>
            <div id="companions-test-container" class="companions-test-grid"></div>
        </section>

        <!-- Environment Variables Check -->
        <section class="test-section">
            <h2 class="test-header">‚öôÔ∏è Environment Check</h2>
            <p>Deze sectie test of alle benodigde environment variables correct zijn ingesteld.</p>
            <div class="test-controls">
                <button onclick="checkEnvironment()">Check Environment</button>
            </div>
            <div id="env-status" class="status loading">Klaar voor test...</div>
            <div id="env-details"></div>
        </section>

        <!-- Test Data Preview -->
        <section class="test-section">
            <h2 class="test-header">üìä Data Preview</h2>
            <p>Preview van de data zoals die uit Airtable komt:</p>
            <div class="test-controls">
                <button onclick="previewData()">Preview Raw Data</button>
                <button onclick="validateSchema()">Validate Schema</button>
            </div>
            <div id="preview-status" class="status loading">Klaar voor test...</div>
            <div id="data-preview" class="api-response"></div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Test Environment</h4>
                    <p>Deze pagina is alleen voor het testen van de Airtable integratie.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/companions.js"></script>
    <script>
        // Test functions
        async function testApiConnection() {
            updateStatus('api-status', 'loading', 'Testing API connection...');
            document.getElementById('api-response').textContent = '';

            try {
                const response = await fetch('/.netlify/functions/get-companions');
                const data = await response.json();

                if (response.ok) {
                    updateStatus('api-status', 'success', `‚úÖ API Success! Retrieved ${data.companions?.length || 0} companions`);
                    document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
                } else {
                    updateStatus('api-status', 'error', `‚ùå API Error: ${response.status} - ${data.error}`);
                    document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                updateStatus('api-status', 'error', `‚ùå Network Error: ${error.message}`);
                document.getElementById('api-response').textContent = error.stack;
            }
        }

        async function testWithFilters() {
            updateStatus('api-status', 'loading', 'Testing API with filters...');

            try {
                const response = await fetch('/.netlify/functions/get-companions?category=ai-girlfriend&limit=3');
                const data = await response.json();

                if (response.ok) {
                    updateStatus('api-status', 'success', `‚úÖ Filter Test Success! Found ${data.companions?.length || 0} ai-girlfriend companions`);
                    document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
                } else {
                    updateStatus('api-status', 'error', `‚ùå Filter Test Error: ${data.error}`);
                }
            } catch (error) {
                updateStatus('api-status', 'error', `‚ùå Filter Test Error: ${error.message}`);
            }
        }

        async function testSorting() {
            updateStatus('api-status', 'loading', 'Testing sorting...');

            try {
                const response = await fetch('/.netlify/functions/get-companions?sort=rating&limit=5');
                const data = await response.json();

                if (response.ok) {
                    updateStatus('api-status', 'success', `‚úÖ Sorting Test Success! Retrieved ${data.companions?.length || 0} companions sorted by rating`);
                    document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
                } else {
                    updateStatus('api-status', 'error', `‚ùå Sorting Test Error: ${data.error}`);
                }
            } catch (error) {
                updateStatus('api-status', 'error', `‚ùå Sorting Test Error: ${error.message}`);
            }
        }

        async function testCompanionCards() {
            updateStatus('render-status', 'loading', 'Testing companion card rendering...');

            try {
                await companionManager.renderAllCompanions('companions-test-container', 'rating');
                updateStatus('render-status', 'success', '‚úÖ Companion cards rendered successfully!');
            } catch (error) {
                updateStatus('render-status', 'error', `‚ùå Render Error: ${error.message}`);
            }
        }

        async function testFeaturedOnly() {
            updateStatus('render-status', 'loading', 'Testing featured companions...');

            try {
                await companionManager.renderFeaturedCompanions('companions-test-container', 6);
                updateStatus('render-status', 'success', '‚úÖ Featured companions rendered successfully!');
            } catch (error) {
                updateStatus('render-status', 'error', `‚ùå Featured Render Error: ${error.message}`);
            }
        }

        async function testByCategory() {
            updateStatus('render-status', 'loading', 'Testing category filtering...');

            try {
                await companionManager.renderCompanionsByCategory('companions-test-container', 'ai-girlfriend', 4);
                updateStatus('render-status', 'success', '‚úÖ Category companions rendered successfully!');
            } catch (error) {
                updateStatus('render-status', 'error', `‚ùå Category Render Error: ${error.message}`);
            }
        }

        async function checkEnvironment() {
            updateStatus('env-status', 'loading', 'Checking environment variables...');

            try {
                const response = await fetch('/.netlify/functions/get-companions');

                if (response.ok) {
                    updateStatus('env-status', 'success', '‚úÖ Environment variables correctly configured!');
                    document.getElementById('env-details').innerHTML = `
                        <p>‚úÖ AIRTABLE_TOKEN_CG: Configured</p>
                        <p>‚úÖ AIRTABLE_BASE_ID_CG: Configured</p>
                        <p>‚úÖ AIRTABLE_TABLE_ID_CG: Configured</p>
                    `;
                } else {
                    const data = await response.json();
                    updateStatus('env-status', 'error', '‚ùå Environment configuration issue');
                    document.getElementById('env-details').innerHTML = `<p>Error: ${data.error}</p>`;
                }
            } catch (error) {
                updateStatus('env-status', 'error', '‚ùå Environment check failed');
                document.getElementById('env-details').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        async function previewData() {
            updateStatus('preview-status', 'loading', 'Loading raw data preview...');

            try {
                const companions = await companionManager.fetchCompanions({ limit: 3 });
                updateStatus('preview-status', 'success', `‚úÖ Data preview loaded (${companions.length} items)`);
                document.getElementById('data-preview').textContent = JSON.stringify(companions, null, 2);
            } catch (error) {
                updateStatus('preview-status', 'error', `‚ùå Preview Error: ${error.message}`);
            }
        }

        async function validateSchema() {
            updateStatus('preview-status', 'loading', 'Validating data schema...');

            try {
                const companions = await companionManager.fetchCompanions({ limit: 1 });

                if (companions.length === 0) {
                    updateStatus('preview-status', 'error', '‚ùå No data found to validate');
                    return;
                }

                const companion = companions[0];
                const requiredFields = ['name', 'slug', 'rating', 'description', 'short_description', 'website_url', 'affiliate_url', 'image_url'];
                const missingFields = requiredFields.filter(field => !companion[field]);

                if (missingFields.length === 0) {
                    updateStatus('preview-status', 'success', '‚úÖ Schema validation passed!');
                    document.getElementById('data-preview').textContent = `Schema validation successful!\n\nSample companion:\n${JSON.stringify(companion, null, 2)}`;
                } else {
                    updateStatus('preview-status', 'error', `‚ùå Missing fields: ${missingFields.join(', ')}`);
                    document.getElementById('data-preview').textContent = `Missing fields: ${missingFields.join(', ')}\n\nSample data:\n${JSON.stringify(companion, null, 2)}`;
                }
            } catch (error) {
                updateStatus('preview-status', 'error', `‚ùå Schema validation error: ${error.message}`);
            }
        }

        function clearResults() {
            document.getElementById('api-response').textContent = '';
            document.getElementById('companions-test-container').innerHTML = '';
            updateStatus('api-status', 'loading', 'Results cleared');
            updateStatus('render-status', 'loading', 'Results cleared');
        }

        function updateStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // Auto-run environment check on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkEnvironment, 1000);
        });
    </script>
</body>
</html>